<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Typing Test</title>
    <link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>
    <form id="startForm">
        <label for="userName">Your Name:</label>
        <input type="text" id="userName" name="userName" required />
        <label for="teacherName">Select Teacher:</label>
        <select id="teacherName" name="teacherName" required>
            <option value="Camps">Camps</option>
            <option value="Cope">Cope</option>
            <option value="Diede">Diede</option>
            <option value="McKee">McKee</option>
            <option value="Sorensen">Sorensen</option>
            <option value="Staheli">Staheli</option>
            <option value="Wright">Wright</option>
            <!-- Add more options as needed -->
        </select>
        <button type="button" onclick="startTypingTest()">
            Start Typing Test
        </button>
    </form>

    <div id="typingTestScreen" style="display: none">
        <h2>Typing Test</h2>
        <p>Welcome, <span id="typedUserName"></span>! <br> Please wait for Mrs. Blazzard before you Start</p>
        <p id="textToType">
            <span id="testCount"></span>
        <p><br></p>
        The test will auto submit after the Minute is up. Please wait for Mrs Blazzard before you Start again!
        </p Hide>

        <label for="userInput">Your Test:</label>
        <textarea id="userInput" rows="4" cols="50" oninput="startTimer()" onkeydown="handleTabKey(event)"></textarea>

        <button type="button" style="display: none;" onclick="submitTypingTest()">Submit</button>

        <div id="results" style="display: none">
            <h3>Results</h3>
            <p id="errorCount"></p>
            <p id="score"></p>
        </div>
    </div>

    <script>
        let timer;
        let startTime;
        let userInput = "";
        let testCounter = 1; // Counter for the number of tests
        const maxTests = 3; // Maximum number of tests
        const masterText =
            "Typing, or keyboarding, has always been important: but it is much more important now than ever before because computer keyboards are important to almost every part of our lives. We use keyboards like we used to use pens and pencils. We want to be the very fastest keyboarders. Typing, or keyboarding, has always been important: but it is much more important now than ever before because computer keyboards are important to almost every part of our lives. We use keyboards like we used to use pens and pencils. We want to be the very fastest keyboarders.";

        document.addEventListener("copy", function (e) {
            e.preventDefault();
        });

        document.addEventListener("paste", function (e) {
            e.preventDefault();
        });

        document.querySelector("input").spellcheck = false;

        function startTypingTest() {
            if (document.getElementById("userName").value.length > 2) {
                // Hide the start form
                document.getElementById("startForm").style.display = "none";

                // Show the typing test screen
                document.getElementById("typingTestScreen").style.display = "block";

                // Display the user's name on the typing test screen
                const userName = document.getElementById("userName").value;
                document.getElementById("typedUserName").innerText = userName;

                // Display the current test number
                document.getElementById(
                    "testCount"
                ).innerText = `Test ${testCounter}`;

                // Record the start time
                startTime = new Date().getTime();
            }
            else
            {
                alert("You need to Enter Your Name!")
            }
        }

        function handleTabKey(event) {
            // Handle the Tab key press
            if (event.key === "Tab") {
                event.preventDefault(); // Prevent the default Tab behavior (e.g., moving focus)

                // Get the current cursor position
                const cursorPosition = document.getElementById("userInput").selectionStart;

                // Get the text before and after the cursor position
                const textBeforeCursor = document.getElementById("userInput").value.substring(0, cursorPosition);
                const textAfterCursor = document.getElementById("userInput").value.substring(cursorPosition);

                // Insert an indent (e.g., four spaces)
                const updatedText = textBeforeCursor + "    " + textAfterCursor;

                // Update the textarea value with the modified text
                document.getElementById("userInput").value = updatedText;

                // Move the cursor to the position after the inserted indent
                document.getElementById("userInput").setSelectionRange(cursorPosition + 4, cursorPosition + 4);
            }
        }

        function startTimer() {
            // Start the timer only if it hasn't started yet
            if (!timer) {
                timer = setTimeout(submitTypingTest, 60000); // One minute (60,000 milliseconds)
            }
        }

        function submitTypingTest() {
            // Clear the timer
            clearTimeout(timer);

            // Retrieve the user's typing input
            const userInput = document.getElementById("userInput").value;

            // Calculate the score and errors
            const { errors, errorCount } = calculateErrors(userInput, masterText);
            const score = calculateScore(userInput.length, errorCount);

            // Display the results
            document.getElementById("errorCount").innerText = `Errors: ${errorCount}`;
            document.getElementById("score").innerText = `Score: ${score}`;
            document.getElementById("results").style.display = "block";

            const data = {
                userName: document.getElementById("userName").value,
                teacherName: document.getElementById("teacherName").value,
                score: score,
                errorCount: document.getElementById("userInput").value
            }

            submitToGoogleSheet(data);

            // If there are more tests, reset the timer and allow the user to start the next test
            if (testCounter < maxTests) {
                testCounter++;
                timer = null; // Reset the timer
                document.getElementById("userInput").value = ""; // Clear the user input
                document.getElementById("results").style.display = "none"; // Hide the results
                startTypingTest(); // Start the next test
            } else {
                // If all tests are completed, show a message or perform any additional actions
                alert("All tests completed!");
                location.reload();
            }
        }

        function calculateErrors(userInput, masterText) {
            let errors = 0;
            let errorCount = 0;
            let lastCorrectPosition = 0;

            // Ensure both strings have the same length
            const minLength = Math.min(userInput.length, masterText.length);

            for (let i = 0; i < minLength; i++) {
                if (userInput[i] !== masterText[i]) {
                    errors++;
                    errorCount++;

                    // Update the last correctly typed position
                    lastCorrectPosition = i + 1;
                }
            }

            // Add the remaining characters from the longer string as errors
            errors += Math.abs(userInput.length - masterText.length);

            // If there was a mismatch, adjust the error count
            if (lastCorrectPosition < userInput.length) {
                errorCount -= Math.abs(userInput.length - masterText.length);
            }

            return { errors, errorCount };
        }


        function calculateScore(totalCharactersTyped, errorCount) {
            // For simplicity, you can customize the scoring logic based on your requirements
            // Here, the score is calculated as (total characters typed / 5) - (errorCount)
            return Math.max(0, Math.floor(totalCharactersTyped / 5));
        }

        function submitToGoogleSheet(data) {
            const url =
                "https://script.google.com/macros/s/AKfycbx5MXy6YuRvoaWldDzQ6Yf8xIy5xG8kOCJcRt5bRRdIxxG5YnBj-u7V2ibH2RM6nbrszQ/exec" +
                "?callback=submitCallback";
            fetch(url, {
                redirect: "follow",
                method: "POST",
                mode: "no-cors", // Set the request's mode to 'no-cors'
                headers: {
                    "Content-Type": "text/plain;application/json",
                },
                body: JSON.stringify(data),
            })
                .then((response) => {
                    if (!response.ok) {
                        throw new Error("Network response was not ok");
                    }
                    return response.text();
                })
                .then((text) => console.log(text))
                .catch((error) => console.error("Error:", error));
        }
    </script>
</body>

</html>